<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2024 UK election data "what if"</title>
<style>
  body {
    max-width: 40em;
    margin: auto;
    padding: 0.5em;
  }
  #seatsGraph {
    display: flex;
    height: 50vh;
    border: thin dashed red;
    flex-direction: row;
    align-items: flex-end;
    padding: 0.5em;
    gap: 0.5em;
  }
  #seatsGraph * {
    flex: 1 1 0;
    border: solid thin black;
    border-radius: 0.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    min-height: 1.5em;
  }
</style>

<h1>2024 UK election data "what if"</h1>

<p>
  This little app lets you see what the results of the 2024 UK general election might have been if a
  certain proportion of voters for one party actually voted for another.
</p>
<p>
  I made it because I wanted to see what would happen if some RUK voters voted for the Tories
  instead.
</p>

<p>Number of constituencies: <span id="numOfConst"></span></p>

<div id="seatsGraph"></div>
<section id="sliders"></section>

<section>
  <h2>Further information</h2>

  <p>
    The data comes
    <a href="https://commonslibrary.parliament.uk/research-briefings/cbp-10009/"
      >from the UK Parliament</a
    >.
  </p>

  <p>
    The sliders apply one after the other, so if one slider assigns 20% Labour votes to Tories, and
    the next assigns 10% Labour votes to Lib Dems, then Lib Dems would get 8% of the original Labour
    votes because after the first slider, only 80% of the votes were available to be shifted.
  </p>
</section>

<script type="module">
  import data from './data.js';

  const parties = [
    'Con',
    'Lab',
    'LD',
    'RUK',
    'Green',
    'SNP',
    'PC',
    'DUP',
    'SF',
    'SDLP',
    'UUP',
    'APNI',
    'OTHWin',
  ];

  const showingSliders = [{ from: 'RUK', to: 'Con' }, { from: 'RUK' }];

  makeSliders();

  const partiesToShow = ['Con', 'Lab', 'LD', 'SNP', 'RUK', 'Other'];
  const partyColors = {
    Lab: '#d6382580',
    Con: '#3373c380',
    LD: '#f19f3980',
    SNP: '#f8d25380',
    RUK: '#60cedd80',
    Other: '#88888880',
  };

  window.numOfConst.textContent = data.length;
  showSeats(computeSeats(data, parties));

  function makeSliders() {
    window.sliders.textContent = '';

    for (let i = 0; i < showingSliders.length; i++) {
      const { from, to } = showingSliders[i];

      const p = document.createElement('p');
      p.append(from);
      p.append(to ? ' to ' + to : ' not voting');

      const slider = document.createElement('input');
      slider.type = 'range';
      slider.dataset.from = from;
      slider.dataset.to = to || 'no party';
      slider.value = 0;
      slider.min = 0;
      slider.max = 100;
      slider.step = 1;
      slider.addEventListener('input', redraw);
      slider.addEventListener('input', updateValue);

      const valueSpan = document.createElement('span');
      valueSpan.className = 'value';
      valueSpan.textContent = '0';

      const bin = document.createElement('span');
      bin.append('❌');
      bin.addEventListener('click', () => removeSlider(i));

      p.append(' ', slider, ' ', valueSpan, '% ', bin);
      window.sliders.append(p);
    }
  }

  function removeSlider(i) {
    showingSliders.splice(i, 1);
    makeSliders();
  }

  function updateValue(e) {
    const el = e.target;
    const valueEl = e.target.parentElement.querySelector('.value');
    if (valueEl) valueEl.textContent = el.valueAsNumber;
  }

  function redraw() {
    let updated = data;
    for (const slider of document.querySelectorAll('#sliders input')) {
      const value = slider.valueAsNumber;
      updated = shiftVotes(updated, slider.dataset.from, slider.dataset.to, value / 100);
    }

    showSeats(computeSeats(updated, parties));
  }

  function shiftVotes(data, fromParty, toParty, proportion) {
    return data.map((constituency) => ({
      ...constituency,
      [toParty]: constituency[toParty] + proportion * constituency[fromParty],
      [fromParty]: constituency[fromParty] * (1 - proportion),
    }));
  }

  function showSeats(seats) {
    window.seatsGraph.textContent = '';
    const max = data.length; // Math.max(...Object.values(seats));

    // compute seaths by parties not shown
    seats.Other = 0;
    for (const party of Object.keys(seats)) {
      if (!partiesToShow.includes(party)) seats.Other += seats[party];
    }

    for (const party of partiesToShow) {
      const div = document.createElement('div');
      div.style.height = (seats[party] / max) * 100 + '%';
      div.textContent = party + ': ' + seats[party];
      div.style.backgroundColor = partyColors[party];
      window.seatsGraph.append(div);
    }
  }

  function computeSeats(data, parties) {
    const seats = Object.fromEntries(parties.map((p) => [p, 0]));

    for (const constituency of data) {
      const counts = parties.map((party) => constituency[party]);
      assert(counts.every((c) => typeof c === 'number'));

      const winner = getWinner(counts, parties);
      seats[winner] += 1;
    }

    return seats;
  }

  function getWinner(counts, parties) {
    let winner = parties[0];
    let winningCount = counts[0];
    for (let i = 1; i < parties.length; i++) {
      const party = parties[i];
      const count = counts[i];
      if (count > winningCount) {
        winner = party;
        winningCount = count;
      }
    }
    return winner;
  }

  function assert(condition) {
    if (!condition) throw new Error('assertion failed');
  }
</script>
